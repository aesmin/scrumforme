{{extend 'default/layout_base.html'}}

<script>
    // OBS: other global variables are generated on the page project
    var url = {
        createUpdateBacklogItens : '{{=URL("create_update_itens.json")}}',
        changeAjaxItens : '{{=URL("board_ajax_tasks")}}',
        removeTask : '{{=URL("remove_itens")}}',
    },
    msg = {
        field_empty : '{{=T("Click to write")}}',
        validation_error : '{{=T("Can not be empty")}}',
        confirm : '{{=T("Are you sure you want to continue?")}}',
        task_undated : '{{=T("You must first put a start date or move to IN PROGRESS column")}}',
        task_no_belong : '{{=T("This task does not belong to another definition of ready")}}',
        remove_sucess : '{{=T("Removed Successfully!")}}',
        remove_error : '{{=T("Error in removal!")}}',
        type_error : 'error',
        type_success : 'success',
    },
    date = {
        sprint_started : '{{=sprint.started}}',
        weeks : '{{=sprint.weeks}}',
    }
</script>

<div id="target_ajax"></div>

<div id="sub-header-content">
    <div id="content-header">
        <div id="breadcrumb">
            <a href='{{=URL("index")}}' title="{{=T('Go to')}} {{=T('Home')}}" class="tip-bottom"><i class="icon-home"></i> Home</a>
            <a href="#" class="current">{{=T('Board')}}</a>
        </div>
        <div id="header-name" class="pull-left">
            <h1>{{=project.name}}</h1>
        </div>
        <div id="sprint-name" class="span5 pull-right">
            <h4><span>{{=sprint.name}}</span> - {{=sprint.weeks}} {{=T('Weeks')}}</h5>
        </div>
        <div class="clearfix"></div>
    </div>
</div>

<div id="info_content" class="row-fluid">
    <div id="project_info" class="span4">
        <p>{{=project.description}}</p>
        <p>{{=g_blank_fulldate_check(project.date_)}} <a href="{{=project.url}}" target="_blank">{{=project.url}}</a></p>
    </div>
    <div id="time_sprint" class="span4">
        <div id="clock">
            <i class="icon-time pull-left"></i>
            <div class="pull-left">
                {{from datetime import timedelta}}
                {{estimated_date = sprint.started + timedelta(days=7*sprint.weeks)}}
                <p>{{=T('Started in')}}: <strong>{{=g_blank_fulldate_check(sprint.started)}}</strong></p>
                <p>{{=T('Estimated for')}}: <strong>{{=g_blank_fulldate_check(estimated_date)}}</strong></p>
            </div>
            <div class="clearfix"></div>
        </div>
    </div>
    <div id="live_search" class="span3">
        <input type="text" name="livesearch" placeholder='{{=T("Search on Sprint")}}' alt='{{=T("Search on Sprint")}}' title='{{=T("Search on Sprint")}}'>
        <p id="nothingfound">{{=T("No name match your search!")}}</p>
    </div>
</div>

<div class="nav-status">
    <div class="column">
        <h4>{{=T('Definition of Ready')}}</h4>
    </div>
    <div class="column">
        <h4>{{=T('To Do')}}</h4>
    </div>
    <div class="column">
        <h4>{{=T('In Progress')}}</h4>
    </div>
    <div class="column">
        <h4>{{=T('Verification')}}</h4>
    </div>
    <div class="column">
        <h4>{{=T('Done')}}</h4>
    </div>
</div>

{{definition_ids =[]}}
{{for story in stories:}}
    {{count = 0}}
    {{for df in definition_ready[story.id]:}}
        {{if not definition_ready[story.id][count].story_id in definition_ids:}}
        <!-- custom class to expand / collapse tables of the same story -->
        <table class="table story{{=definition_ready[story.id][count].story_id}}" data-storyid='{{=definition_ready[story.id][count].story_id}}'>
            <tr>
                <th class="story_header" colspan=5>
                    <div class="text_container">
                        <h5><a href="#" class="editable-click story_card editable" data-type="text" data-placeholder="Click para escrever" data-pk="{{=story.id}}" data-url="{{=URL('create_update_itens.json')}}" data-name="story" data-update="true">{{=story.title}}</a></h5>
                    </div>
                    <div class="buttons_container">
                        <button class="btn btn-minimize expand_story pull-right" alt='{{=T("Expand")}}' title='{{=T("Expand")}}'>
                            <i class="icon-circle-arrow-up"></i></button>
                        <input class="pull-right benefit" type="text" placeholder='?' value='{{=g_blank_check(story.benefit)}}' alt='{{=T("Benefit")}}' title='{{=T("Benefit")}}' disabled>
                        <input class="pull-right story_points" type="text" placeholder="?" value='{{=g_blank_check(story.story_points)}}' alt='{{=T("Story Points")}}' title='{{=T("Story Points")}}' disabled>
                    </div>
                    <div class="clearfix"></div>
                </div>                            
                </th>
            </tr>
            <tr class="item_container" data-definitionready='{{=definition_ready[story.id][count].id}}'>
            {{definition_ids.append(definition_ready[story.id][count].story_id)}}
        {{else:}}
        <!-- for Definition of Ready which are part of the same story -->
        <table class="table no-th story{{=definition_ready[story.id][count].story_id}}" data-storyid='{{=definition_ready[story.id][count].story_id}}'>
            <tr class="item_container" data-definitionready='{{=definition_ready[story.id][count].id}}'>
        {{pass}}
                <td>
                    <p class="definition_ready_title">{{=definition_ready[story.id][count].title}}</p>
                    <p class="vertical create_task" alt='{{=T("Create Task")}}' title='{{=T("Create Task")}}'><i class="icon-plus"></i> {{=T("task")}}</p>
                </td>
                
                <td class="column_task todo" data-status="todo">
                    {{for task in tasks[definition_ready[story.id][count].id]:}}
                        {{if task["status"] == "todo": }}
                        <ul class="task_container">
                          <li class="task">
                            <div class="avatar_container">
                                <img class="avatar_card" src='{{=Gravatar(auth.user.email).thumb}}'>
                            </div>
                            <div class="card_container">
                                <a href="#" class="editable-click editable task_item" data-type="textarea" data-pk='{{=task["id"]}}' data-url="{{=URL('create_update_itens.json')}}" data-name="task" data-update="true">{{=task["title"]}}</a>
                                <div class="icons_card">
                                    <div class="date started_calendar" data-date='{{=g_blank_fulldate_check(task["started"])}}'>
                                        <input class="started_date_text" size="16" type="text" value='{{=g_blank_date_check(task["started"])}}' readonly>
                                        <span class="add-on calendar"><i class="icon-calendar"></i></span>
                                    </div>
                                    <div class="comment"><i class="icon-comment"></i><span>0</span></div>
                                    <span class="delete_item" ><i class="icon-trash"></i></span>
                                </div>
                            </div>
                            <div class="clearfix"></div>
                          </li>
                        </ul>
                        {{pass}}
                    {{pass}}
                </td>
                
                <td class="column_task" data-status="inprogress">
                    {{for task in tasks[definition_ready[story.id][count].id]:}}
                        {{if task["status"] == "inprogress": }}
                        <ul class="task_container">
                          <li class="task">
                            <div class="avatar_container">
                                <img class="avatar_card" src='{{=Gravatar(auth.user.email).thumb}}' width="45px" height="45px">
                            </div>
                            <div class="card_container">
                                <a href="#" class="editable-click editable task_item" data-type="textarea" data-pk='{{=task["id"]}}' data-url="{{=URL('create_update_itens.json')}}" data-name="task" data-update="true">{{=task["title"]}}</a>
                                <div class="icons_card">
                                    <div class="date started_calendar" data-date='{{=g_blank_fulldate_check(task["started"])}}'>
                                        <input class="started_date_text" size="16" type="text" value='{{=g_blank_date_check(task["started"])}}' readonly>
                                        <span class="add-on calendar"><i class="icon-calendar"></i></span>
                                    </div>
                                    <div class="comment"><i class="icon-comment"></i><span>0</span></div>
                                    <span class="delete_item" ><i class="icon-trash"></i></span>
                                </div>
                            </div>
                            <div class="clearfix"></div>
                          </li>
                        </ul>
                        {{pass}}
                    {{pass}}
                </td>
                
                <td class="column_task" data-status="verification">
                    {{for task in tasks[definition_ready[story.id][count].id]:}}
                        {{if task["status"] == "verification": }}
                        <ul class="task_container">
                          <li class="task">
                            <div class="avatar_container">
                                <img class="avatar_card" src='{{=Gravatar(auth.user.email).thumb}}' width="45px" height="45px">
                            </div>
                            <div class="card_container">
                                <a href="#" class="editable-click editable task_item" data-type="textarea" data-pk='{{=task["id"]}}' data-url="{{=URL('create_update_itens.json')}}" data-name="task" data-update="true">{{=task["title"]}}</a>
                                <div class="icons_card">
                                    <div class="date started_calendar" data-date='{{=g_blank_fulldate_check(task["started"])}}'>
                                        <input class="started_date_text" size="16" type="text" value='{{=g_blank_date_check(task["started"])}}' readonly>
                                        <span class="add-on calendar"><i class="icon-calendar"></i></span>
                                    </div>
                                    <div class="comment"><i class="icon-comment"></i><span>0</span></div>
                                    <span class="delete_item" ><i class="icon-trash"></i></span>
                                </div>
                            </div>
                            <div class="clearfix"></div>
                          </li>
                        </ul>
                        {{pass}}
                    {{pass}}
                </td>
                
                <td class="column_task" data-status="done">
                    {{for task in tasks[definition_ready[story.id][count].id]:}}
                        {{if task["status"] == "done": }}
                        <ul class="task_container">
                          <li class="task">
                            <div class="avatar_container">
                                <img class="avatar_card" src='{{=Gravatar(auth.user.email).thumb}}' width="45px" height="45px">
                            </div>
                            <div class="card_container">
                                <a href="#" class="editable-click editable task_item" data-type="textarea" data-pk='{{=task["id"]}}' data-url="{{=URL('create_update_itens.json')}}" data-name="task" data-update="true">{{=task["title"]}}</a>
                                <div class="icons_card">
                                    <div class="date started_calendar" data-date='{{=g_blank_fulldate_check(task["started"])}}'>
                                        <input class="started_date_text" size="16" type="text" value='{{=g_blank_date_check(task["started"])}}' readonly>
                                        <span class="add-on calendar"><i class="icon-calendar"></i></span>
                                    </div>
                                    <div class="comment"><i class="icon-comment"></i><span>0</span></div>
                                    <span class="delete_item" ><i class="icon-trash"></i></span>
                                </div>
                            </div>
                            <div class="clearfix"></div>
                          </li>
                        </ul>
                        {{pass}}
                    {{pass}}
                </td>
                {{count += 1}}
            {{pass}}
        </tr>
    </table>
{{pass}}

